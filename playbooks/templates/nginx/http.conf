{% for d in redirect_domains %}server {
    if ($host = {{ d }}) {
        return 301 https://{{ domain }}$request_uri;
    }
    listen      80;
    server_name {{ d }};
}
{% endfor %}

# uWSGI connection to the Studio Django app.
upstream studio_{{ env }}_app {
    server {{ uwsgi_socket }};
}

server {
    server_name {{ domain }};
    {% for d in redirect_domains %}if ($host = {{ d }}) {
        return 301 https://{{ domain }}$request_uri;
    }
    {% endfor %}
    if ($host !~* ^({{ domain }})$) {
        return 444;
    }

    access_log /var/log/nginx/{{ domain }}-access.log;
    error_log /var/log/nginx/{{ domain }}-error.log;

    # Redirects
    rewrite ^/spring /films/spring permanent;
    rewrite ^/sprite-fright /films/sprite-fright permanent;
    rewrite ^/charge$ /films/charge permanent;
    rewrite ^/films/heist/(.*)$ /films/charge/$1 permanent;

    include {{ dir.config }}/studio.common.conf;

    location / {
        uwsgi_pass  studio_{{ env }}_app;
        # FIXME(anna): move to uwsgi_params after LB proxying is no more.
        uwsgi_param HOST $host;
        include     {{ dir.config }}/studio_uwsgi_params;
    }

}

# Proxied server config. Assumes the TLS termination is done upstream.
server {
    listen 80;
    server_name 10.129.22.239;
    server_name cloudbalance.blender.org;
    server_name cloud.blender.org;

    include {{ dir.config }}/studio.common.conf;

    # Only allow HTTP traffic from our private network.
    allow 10.129.0.0/16;
    deny all;

    location / {
        uwsgi_pass  studio_{{ env }}_app;
        include     {{ dir.config }}/studio_uwsgi_params;

        # Override some parameters to let uWSGI know the client is
        # using HTTPS.
        uwsgi_param  REQUEST_SCHEME     https;
        uwsgi_param  HTTPS              true;

        # Parameters that are not in the default studio_uwsgi_params,
        # but are documented on https://uwsgi-docs.readthedocs.io/en/latest/Vars.html
        uwsgi_param  UWSGI_SCHEME       https;
    }
}
